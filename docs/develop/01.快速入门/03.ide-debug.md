# 断点单步调试

NextPilot支持 Keil5 MDK 和 VSCode 两种集成开发环境，两者都是先通过scons工具生成相应的 Keil 工程和 VSCode 配置，然后再使用 IDE 进行编译、调试、烧录等。

> 注意：飞行仿真sitl/qemu只支持Vscode+Gcc，不支持keil；普通STM32程序支持Vscode和Keil，但是推荐Keil。

Vscode一款很好的编辑器，拥有极强的扩展性，因此推荐使用VScode进行代码编辑，至于编译和调试可以根据个人喜好了。

## Keil5 MDK

### 生成Keil工程

通过 scons 工具直接生成 keil 工程，然后用MDK进行开发。

```
# 切换target目录
cd nextpilot-flight-control/bsps/fcs-v1

# 生成keil工程，然后使用mdk进行调试
scons --target=mdk5
```

### 打开Keil工程

> 注意：MDK建议使用V5.38版本，编译器采用ARMCLANG v6.19，开启支持C++14。

用 keil 打开 nextpilot-flight-control/bsps/fcs-v1/project.uvprojx，接下来就可以愉快的使用Keil进行项目的开发了。

## VS Code

VS Code（全称 [Visual Studio Code](https://azure.microsoft.com/zh-cn/products/visual-studio-code/)）是一个轻量且强大的代码编辑器，支持 Windows，OS X 和 Linux。内置 JavaScript、TypeScript 和 Node.js 支持，而且拥有丰富的插件生态系统，可通过安装插件来支持 C++、C#、Python、PHP 等其他语言。

### 安装和配置

下载[Visual Stuio Code](https://azure.microsoft.com/zh-cn/products/visual-studio-code/)，一路默认安装即可。然后使用vscode打开`nextpilot-flight-control.code-workspace`，如果是第一次打开会提醒您安装`推荐扩展`，一定要点`确定`哈，会自动安装以下扩展：

- ms-ceintl.vscode-language-pack-zh-hans
- ms-vscode.cpptools
- ms-vscode.cpptools-extension-pack
- ms-vscode.cpptools-themes
- ms-python.python
- ms-python.debugpy
- ms-python.black-formatter
- ms-vscode.vscode-embedded-tools
- marus25.cortex-debug
- rt-thread.rt-thread-studio
- nordic-semiconductor.nrf-kconfig
- DavidAnson.vscode-markdownlint
- samuelcolvin.jinjahtml
- tamasfe.even-better-toml
- redhat.vscode-yaml

当然您也可以手动安装相应的扩展，比如：

![](./image/vscode-install-plugin.png)

安装好后确认插件为以下状态，如果不是则点击重新加载：

![](./image/vscode-plugin-status.png)

### 编译和调试

#### 打开工作区

双击根目录下的`nextpilot-flight-control.code-workspace`即可打开VSCode工作区。如下图所示：

![image-20230420172023916](image\vscode_open_ws.png)

#### 选择工程

在打开工作区后，点击左侧 RT-Thread Studio插件，选择一个bsp工程，比如`qemu-vexpress-a9`，如下图所示：

![image-20230420172023916](image\vscode_fcs_project.png)

将鼠标放置到 qemu 工程，会自动弹出开发工具栏图标，包括了编译、烧写、调试、擦除，在使用这些功能之前，需要配置下`.vscode/setting.json`和`.vscode/launch.json`文件，不过 nextpilot 已经为您做好了这一切，您只要在`qemu-vexpress-a9`目录下运行`scons`会自动帮您生成所需的配置文件。

#### 编译工程

配置完成后，点击编译按钮，即可进行工程编译。

![image-20230420172023916](image\vscode_build.png)

选择fcs bsp或点击编译后，vscode的TERMINAL终端会自动启动env环境然后切换至fcs所在目录。

![](image\vscode_terminal.png)

#### 烧写程序

完成编译后，点击烧写按钮，即可进行固件烧写。

![image-20230420172023916](image\vscode_download.png)

烧写打印结果如下图所示：

![](image\vscode_download_result.png)

> 要想固件正常运行，一定要提前烧写bootloader。具体请参考。

#### 单步调试

按调试按钮，或者按F5，可以进行调试。

![](image\vscode_debug.png)

> 注意：只有BUILD选项为'debug'时才能够进行调试。

进入调试后的效果如下图所示：

![](image\vscode_debug_ing.png)
