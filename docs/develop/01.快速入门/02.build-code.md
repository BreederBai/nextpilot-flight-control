# 编译飞控代码

在编译之前，请[按照教程安装开发工具链](./1-toolchain.md)。

## 下载代码

先从git服务器上克隆代码到本地。

**命令行操作**

```
mkdir -p ~/Workspace
cd ~/Workspace
git clone https://github.com/nextpilot/nextpilot-flight-control.git
```
**Git-Tortoise**
To be done

## 配置环境

由于env是RT-Thread的开发工具，但是NextPilot开发过程中会执行一些自动化脚本，这部分工具env没有提供，因此在编译之前，需要先安装/配置这部分工具。在nextpilot-flight-control目录右击选择ConEmu Here打开env终端，然后在终端里面输入以下命令：
```shell
# 安装nextpilot开发所需的额外工具
./windows-install.bat
```
> 注意：该命令只需要运行一次即可，**且必须在env终端里面运行**。

## 编译代码

```
# 切换到target目录
cd nextpilot-flight-control/bsps/cetcs/fcs-v4
# 编译工程，在build目录下会生成bin和elf文件
scons -j8
# 如果希望同时烧入代码（需要链接st-link）
scons -j8 --upload
```

## 飞行仿真

NextPilot虚拟飞行基于qemu硬件模拟器，飞控内部运行一套六自由度模型（SDOFS）用来生成控制所需的传感器数据，驱动控制算法、组合导航、通信链路等运行，也就是qemu虚拟飞行脱离硬件的束缚，可以在Windows或Linux跑同一套飞控代码，除了spi、i2c、pwm等硬件驱动不执行，跟都**跟真实飞行的逻辑、算法、功能是完全一样**的，当然也可以链接地面站等。另外qemu虚拟飞行还支持**单步断点调试**。更加详细参见[飞行仿真](../E.%E9%A3%9E%E8%A1%8C%E4%BB%BF%E7%9C%9F/sitl_qemu.md)章节。

> 注意：使用qemu进行虚拟飞行仿真，必须安装tap虚拟网卡，并且将tap与真实网卡桥接或共享。

```
# 切换qemu目录
cd nextpilot-flight-control/bsps/sitl/qemu-vexpress-a9
# 编译工程
scons -j8
# 在qemu模拟器中运行nextpilot
qemu.bat
```
此时终端输出调试串口打印信息，我们可以在终端输入命令和飞控进行交互，**打开地面站软件**能够自动链接nextpilot进行正常的飞行、航线等正常操作，**跟真实飞行无异**。
```
> qemu.bat
WARNING: Image format was not specified for 'sd.bin' and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the 'raw' format explicitly to remove the restrictions.
dsound: Could not initialize DirectSoundCapture
dsound: Reason: No sound driver is available for use, or the given GUID is not a valid DirectSound device ID
lwIP-2.0.3 initialized!

=================================================================
         _   __             __   ____   _  __        __
        / | / /___   _  __ / /_ / __ \ (_)/ /____   / /_
       /  |/ // _ \ | |/_// __// /_/ // // // __ \ / __/
      / /|  //  __/_>  < / /_ / ____// // // /_/ // /_
     /_/ |_/ \___//_/|_| \__//_/    /_//_/ \____/ \__/

 Copyright All Reserved (C) 2015-2023 NextPilot Development Team
=================================================================
HW ARCH: SITL-QEMU-A9
HW  MCU: ARM Cortex-A9(devid 0 revid 0)
HW  UID: 000
FW  VER: v3.10_begin_test-5-gb52f116a-dirty(zhanfuyu)
FW HASH: b52f116a0bd7cf042b4c9f3103196605352cc23b
OS  VER: RT-Thread V4.1.1(255)
OS HASH: aab2428d4177a02cd3b0fd020e47a88de379a6ab
Toolchain: GNU GCC 10.3.1 20210824 (release)
Build  URI: zhanfuyu@192.168.1.10(DESKTOP-JTKLBS9)
Build TIME: Apr  8 2023 14:35:42
--------------------------------------------------------------
[40] W/param: can't find param IMU_GYRO_RATEMAX
[40] W/param: can't find param IMU_INTEG_RATE
[46] I/sal.skt: Socket Abstraction Layer initialize success.
[46] I/utest: utest is initialize success.
[46] I/utest: total utest testcase num: (95)
[73] I/SDIO: SD card capacity 524288 KB.
```
